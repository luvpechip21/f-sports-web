<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Jusain Tera ‚Äì ƒê·∫∑t h√†ng nhanh</title>

  <!-- ‚úÖ G·ªåI FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- ‚úÖ FACEBOOK PIXEL (2 pixel + VC sau 4s) -->
  <script>
  !function(f,b,e,v,n,t,s){
    if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '2551563688514905'); // Pixel #1
  fbq('init', '1738204417066160', {}, {agent: 'plmulti'}); // Pixel #2
  fbq('track', 'PageView'); // PageView

  // ‚úÖ ViewContent sau 4s n·∫øu c√≤n ·ªü l·∫°i trang
  let __vcTimer = setTimeout(() => {
    if (!document.hidden) {
      fbq('track', 'ViewContent', {
        content_name: 'Trang s·∫£n ph·∫©m Jusain Tera',
        content_category: 'Pickleball',
        content_type: 'product_group'
      });
      console.log('‚úÖ ViewContent sent after 4s');
    }
  }, 4000);

  document.addEventListener('visibilitychange', () => {
    if (document.hidden && __vcTimer) { clearTimeout(__vcTimer); __vcTimer = null; }
  });
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=2551563688514905&ev=PageView&noscript=1"/>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=1738204417066160&ev=PageView&noscript=1"/>
  </noscript>

  <!-- ‚úÖ STYLE -->
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: 'Be Vietnam Pro', sans-serif; margin:0; background:#fff; }
    .container { padding:16px; }

    /* Sticky footer */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: #fff; display: flex; align-items: center; gap: 8px;
      border-top: 1px solid #ddd; z-index: 9999; padding: 8px 10px;
    }
    .footer-icon { width: 64px; text-align: center; font-size: 12px; color: #000; text-decoration: none; }
    .footer-icon img { width: 22px; height: 22px; margin-bottom: 4px; }
    .footer-btn {
      flex: 1; height: 48px; background: linear-gradient(90deg, #FF512F, #FF7B2F);
      color: #fff; font-weight: 700; font-size: 18px; border: none; cursor: pointer;
      border-radius: 10px; transition: opacity 0.3s ease;
    }
    .footer-btn:hover { opacity: 0.9; }

    /* Overlay */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; z-index: 9998;
    }

    /* Slide-up Form */
    #slideForm {
      position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.15); transition: bottom 0.4s ease;
      padding: 14px 16px 20px; z-index: 10000; border-top-left-radius: 12px;
      border-top-right-radius: 12px; max-height: 90vh; overflow-y: auto;
    }
    #closeBtn {
      position: sticky; top: 0; margin-left:auto; display:block;
      background: none; border: none; font-size: 28px; font-weight: bold; color: #333; cursor: pointer;
    }

    .price-box { text-align: center; margin-bottom: 12px; }
    .price-old { text-decoration: line-through; color: #888; font-size: 14px; margin-right: 6px; }
    .price-new { font-size: 24px; font-weight: bold; color: #FF512F; }

    .gift-box { text-align: center; background: #fff7f3; padding: 10px; border-radius: 10px; margin-bottom: 12px; }
    .gift-box h4 { color: #FF512F; font-size: 15px; margin-bottom: 8px; }
    .gift-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 14px; color: #444; }

    .variant-title { font-size: 14px; font-weight: 600; margin: 12px 0 6px; }
    .variant-row {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
      border: 1px solid #eee; padding: 10px; border-radius: 10px;
    }
    .variant-row img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }
    .variant-info { flex: 1; margin-left: 12px; font-size: 14px; }
    .quantity-box { display: flex; align-items: center; gap: 6px; }
    .quantity-box button {
      width: 28px; height: 28px; border: 1px solid #ddd; background: #f5f5f5;
      font-weight: bold; font-size: 16px; cursor: pointer; border-radius: 6px;
    }
    .quantity-box input {
      width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; padding: 2px 4px;
    }

    .form-input input, .form-input textarea {
      width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
    }
    textarea { resize: none; height: 64px; }

    /* N√∫t g·ª≠i: tr·∫°ng th√°i "ƒêANG G·ª¨I‚Ä¶" + spinner */
    .submit-btn {
      width: 100%; padding: 12px; background: linear-gradient(90deg, #FF512F, #FF7B2F);
      color: white; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;
      transition: opacity 0.3s ease, filter .2s ease; position: relative;
    }
    .submit-btn:hover { opacity: 0.92; }
    .submit-btn.sending { cursor: not-allowed; filter: grayscale(0.3); }
    .submit-btn.sending::after {
      content: ''; position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.7);
      border-top-color: transparent; animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

    /* Popup c·∫£m ∆°n (fade in/out) */
    #confirmPopup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 10001; text-align: center; width: 90%; max-width: 320px;
      opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease;
    }
    #confirmPopup.show { opacity: 1; visibility: visible; }
    #confirmPopup .title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
    #confirmPopup .sub { font-size: 14px; margin-bottom: 12px; }
    #confirmPopup .ok { font-size: 14px; font-weight: bold; color: #FF512F; }
    #closeConfirm { position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 20px; cursor: pointer; color: #333; }
    .spacer { height: 76px; } /* ch·ª´a ch·ªó cho sticky footer */
  </style>
</head>

<body>
  <div class="container">
    <h1 style="margin:0 0 8px 0; font-size:22px; color:#222;">Jusain Tera ‚Äì ƒê·∫∑t H√†ng Nhanh</h1>
    <p style="margin:0; color:#555;">T·ªëi ∆∞u Pixel: Purchase ch·ªâ b·∫Øn khi email g·ª≠i th√†nh c√¥ng & popup c·∫£m ∆°n hi·ªÉn th·ªã.</p>
  </div>

  <!-- ‚úÖ STICKY FOOTER -->
  <div class="sticky-footer">
    <a class="footer-icon" href="tel:0947420361" aria-label="G·ªçi hotline">
      <img src="https://img.icons8.com/ios-filled/24/000000/phone.png" alt=""> <br>G·ªçi
    </a>
    <a class="footer-icon" href="https://m.me/Lifestyle.Fsport" target="_blank" rel="noopener" aria-label="Chat Messenger">
      <img src="https://img.icons8.com/ios-filled/24/000000/facebook-messenger.png" alt=""> <br>Chat
    </a>
    <button id="btn-atc" class="footer-btn" aria-haspopup="dialog" aria-controls="slideForm">MUA NGAY</button>
  </div>

  <div class="spacer" aria-hidden="true"></div>

  <!-- ‚úÖ OVERLAY -->
  <div id="overlay" class="overlay" role="button" aria-label="ƒê√≥ng form"></div>

  <!-- ‚úÖ POPUP FORM -->
  <div id="slideForm" role="dialog" aria-modal="true" aria-hidden="true">
    <button id="closeBtn" type="button" aria-label="ƒê√≥ng" onclick="toggleForm()">√ó</button>

    <div class="price-box">
      <span class="price-old" id="priceOld">‚Ç´3.100.000</span>
      <span class="price-new" id="totalPrice">‚Ç´1.860.000</span>
    </div>

    <div class="gift-box">
      <h4>üéÅ QU√Ä T·∫∂NG K√àM</h4>
      <div class="gift-grid">
        <span>‚úî T√∫i b·∫£o v·ªá v·ª£t</span>
        <span>‚úî Qu·∫•n c√°n v·ª£t x·ªãn</span>
        <span>‚úî B√≥ng thi ƒë·∫•u</span>
        <span>‚úî D√°n vi·ªÅn</span>
        <span>‚úî X·ªãt v·ªá sinh m·∫∑t v·ª£t</span>
      </div>
    </div>

    <div class="variant-title">Ch·ªçn s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng</div>
    <div id="variantArea"></div>

    <div class="form-input" aria-label="Th√¥ng tin ng∆∞·ªùi nh·∫≠n">
      <input type="text" id="fullname" placeholder="H·ªç v√† t√™n" autocomplete="name" />
      <input type="tel" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" autocomplete="tel" />
      <textarea id="address" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng" autocomplete="street-address"></textarea>
    </div>

    <button class="submit-btn" id="submitBtn" type="button">ƒê·∫∂T H√ÄNG NGAY</button>
  </div>

  <!-- ‚úÖ POPUP C·∫¢M ∆†N -->
  <div id="confirmPopup" role="dialog" aria-live="polite" aria-modal="true" aria-hidden="true">
    <button id="closeConfirm" aria-label="ƒê√≥ng">√ó</button>
    <div class="title">üéâ C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng!</div>
    <div class="sub">ƒê√£ x√°c nh·∫≠n ƒë∆°n h√†ng, ch√∫ng t√¥i s·∫Ω g·ª≠i h√†ng ngay cho b·∫°n.</div>
    <div class="ok">HotLine: 0947420361</div>
  </div>

  <!-- ‚úÖ SCRIPT -->
  <script>
  // ========= C·∫§U H√åNH S·∫¢N PH·∫®M =========
  const variantList = [
    { T√™n: "Tera EP01", ·∫¢nh: "https://i.postimg.cc/XvySt6t2/tera.jpg",   Gi√°: 1800000, Gi√°G·ªëc: 3000000 },
    { T√™n: "Tera EP03", ·∫¢nh: "https://i.postimg.cc/FRytsgr3/tera-3.jpg", Gi√°: 1900000, Gi√°G·ªëc: 3000000 }
  ];

  // ========= TI·ªÜN √çCH CHUNG =========
  function formatPrice(v) { return v.toLocaleString("vi-VN") + "‚Ç´"; }
  function genEventId() {
    if (crypto && crypto.randomUUID) return 'ord_' + crypto.randomUUID();
    return 'ord_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  }

  // ========= HI·ªÇN TH·ªä / POPUP FORM =========
  function toggleForm() {
    const form = document.getElementById("slideForm");
    const overlay = document.getElementById("overlay");
    const footer = document.querySelector(".sticky-footer");
    const isOpen = form.style.bottom === "0px";
    form.style.bottom = isOpen ? "-100%" : "0px";
    overlay.style.display = isOpen ? "none" : "block";
    footer.style.display = isOpen ? "flex" : "none";
    form.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
  }
  document.getElementById("overlay").addEventListener("click", toggleForm);

  document.getElementById("btn-atc").addEventListener("click", () => {
    toggleForm();
    renderVariants();
    // ‚úÖ M·ªü form = b·∫Øt ƒë·∫ßu quy tr√¨nh thanh to√°n
    fbq('track', 'InitiateCheckout', { content_type: 'product_group' });
  });

  // ========= RENDER BI·∫æN TH·ªÇ + GI√Å =========
  function renderVariants() {
    const area = document.getElementById("variantArea");
    area.innerHTML = '';
    variantList.forEach((v, i) => {
      const row = document.createElement("div");
      row.className = "variant-row";
      row.innerHTML = `
        <img src="${v.·∫¢nh}" alt="${v.T√™n}">
        <div class="variant-info">${v.T√™n}<br><small>${formatPrice(v.Gi√°)}</small></div>
        <div class="quantity-box">
          <button type="button" onclick="changeQty(${i}, -1)" aria-label="Gi·∫£m s·ªë l∆∞·ª£ng">-</button>
          <input type="number" id="qty${i}" value="0" min="0" inputmode="numeric" onchange="onQtyManual(${i})" aria-label="S·ªë l∆∞·ª£ng ${v.T√™n}">
          <button type="button" onclick="changeQty(${i}, 1)" aria-label="TƒÉng s·ªë l∆∞·ª£ng">+</button>
        </div>`;
      area.appendChild(row);
    });
    updatePrice();
  }

  let __addToCartFiredForIndex = new Set(); // tr√°nh b·∫Øn ATC nhi·ªÅu l·∫ßn cho c√πng SKU
  function onQtyManual(i) {
    const el = document.getElementById(`qty${i}`);
    let val = Math.max(0, parseInt(el.value || 0));
    const before = parseInt(el.getAttribute('data-before') || 0);
    el.value = val;
    if (before === 0 && val > 0 && !__addToCartFiredForIndex.has(i)) {
      fireAddToCart(i, val);
      __addToCartFiredForIndex.add(i);
    }
    el.setAttribute('data-before', val);
    updatePrice();
  }

  function changeQty(i, delta) {
    const input = document.getElementById(`qty${i}`);
    const before = parseInt(input.value || 0);
    let val = Math.max(0, before + delta);
    input.value = val;
    if (before === 0 && val > 0 && !__addToCartFiredForIndex.has(i)) {
      fireAddToCart(i, val);
      __addToCartFiredForIndex.add(i);
    }
    input.setAttribute('data-before', val);
    updatePrice();
  }

  function updatePrice() {
    let total = 0, oldTotal = 0;
    variantList.forEach((v, i) => {
      const qty = parseInt(document.getElementById(`qty${i}`).value || 0);
      total += qty * v.Gi√°;
      oldTotal += qty * v.Gi√°G·ªëc;
    });
    document.getElementById("totalPrice").innerText = formatPrice(total);
    document.getElementById("priceOld").innerText = formatPrice(oldTotal);
  }

  function fireAddToCart(i, qtyNow) {
    const v = variantList[i];
    const id = `SP-${i+1}`;
    const value = qtyNow * v.Gi√°;
    fbq('track', 'AddToCart', {
      content_ids: [id],
      contents: [{ id, quantity: qtyNow, item_price: v.Gi√° }],
      content_type: 'product',
      value: value,
      currency: 'VND'
    });
  }

  // ========= POPUP C·∫¢M ∆†N & B·∫ÆN PURCHASE =========
  let __confirmShowTimer = null, __confirmAutoCloseTimer = null;
  let __lastOrder = null;     // {items, total, num_items, eventId, key}
  let __purchaseFired = false;

  function orderKey(o) {
    return `${o.total}|${o.items.map(it=>`${it.id}x${it.quantity}`).join(',')}`;
  }

  function sendPurchaseOnce(o) {
    if (!o || __purchaseFired) return;
    const key = o.key || orderKey(o);
    const ssKey = 'fb_purchase_guard_' + key;
    if (sessionStorage.getItem(ssKey) === '1') {
      console.log('‚ÑπÔ∏è Purchase skipped (guard same session).');
      return;
    }
    __purchaseFired = true;
    sessionStorage.setItem(ssKey, '1');

    fbq('track', 'Purchase', {
      value: o.total,
      currency: 'VND',
      content_ids: o.items.map(it => it.id),
      contents: o.items.map(it => ({ id: it.id, quantity: it.quantity, item_price: it.item_price })),
      content_type: 'product',
      num_items: o.num_items
    }, { eventID: o.eventId });

    console.log('‚úÖ Purchase sent with eventID:', o.eventId, o);
  }

  function showConfirmPopup() {
    const popup = document.getElementById("confirmPopup");
    popup.classList.add('show');
    popup.setAttribute('aria-hidden', 'false');

    // ‚úÖ Ch·ªâ b·∫Øn Purchase khi popup ‚ÄúC·∫£m ∆°n‚Äù TH·ª∞C S·ª∞ hi·ªÉn th·ªã
    if (__lastOrder) sendPurchaseOnce(__lastOrder);

    if (__confirmAutoCloseTimer) clearTimeout(__confirmAutoCloseTimer);
    __confirmAutoCloseTimer = setTimeout(hideConfirmPopup, 5000);
  }
  function hideConfirmPopup() {
    const popup = document.getElementById("confirmPopup");
    popup.classList.remove('show');
    popup.setAttribute('aria-hidden', 'true');
    if (__confirmAutoCloseTimer) clearTimeout(__confirmAutoCloseTimer);
    __confirmAutoCloseTimer = null;
  }
  document.getElementById("closeConfirm").addEventListener("click", hideConfirmPopup);

  // ========= G·ª¨I FORM =========
  const submitBtn = document.getElementById('submitBtn');
  function setSendingState(isSending) {
    if (isSending) {
      submitBtn.dataset.originalText = submitBtn.textContent;
      submitBtn.textContent = 'ƒêANG G·ª¨I‚Ä¶';
      submitBtn.classList.add('sending');
      submitBtn.disabled = true;
      submitBtn.setAttribute('aria-busy', 'true');
    } else {
      submitBtn.textContent = submitBtn.dataset.originalText || 'ƒê·∫∂T H√ÄNG NGAY';
      submitBtn.classList.remove('sending');
      submitBtn.disabled = false;
      submitBtn.setAttribute('aria-busy', 'false');
    }
  }

  submitBtn.addEventListener("click", async () => {
    const fullname = document.getElementById("fullname").value.trim();
    const phone    = document.getElementById("phone").value.trim();
    const address  = document.getElementById("address").value.trim();

    if (!fullname || !phone || !address) {
      alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
      return;
    }

    const items = [];
    let total = 0;
    let num_items = 0;
    variantList.forEach((v, i) => {
      const qty = parseInt(document.getElementById(`qty${i}`).value || 0);
      if (qty > 0) {
        items.push({ id: `SP-${i+1}`, name: v.T√™n, quantity: qty, item_price: v.Gi√° });
        total += qty * v.Gi√°;
        num_items += qty;
      }
    });

    if (items.length === 0) {
      alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m!");
      return;
    }

    setSendingState(true);

    const payload = {
      name: fullname,
      phone: phone,
      address: address,
      variant: items.map(it => `${it.name} x ${it.quantity}`).join(", "),
      amount: formatPrice(total),
      _captcha: "false",
      _template: "table",
      _subject: "ƒê∆†N H√ÄNG M·ªöI T·ª™ Jusain Tera"
    };

    try {
      const res = await fetch("https://formsubmit.co/ajax/luvpechip21@gmail.com", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // ‚ùóÔ∏èCH·ªà ti·∫øp t·ª•c n·∫øu g·ª≠i email TH√ÄNH C√îNG
      if (!res.ok) {
        console.error("‚ùå G·ª≠i form kh√¥ng OK:", res.status, res.statusText);
        alert("‚ùå L·ªói g·ª≠i ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i sau.");
        return;
      }

      // L∆∞u order ƒë·ªÉ b·∫Øn Purchase khi popup hi·ªÉn th·ªã
      __lastOrder = {
        items,
        total,
        num_items,
        eventId: genEventId()
      };
      __lastOrder.key = orderKey(__lastOrder);

      // ƒê√≥ng form + hi·ªÉn th·ªã popup sau 1.2s (c·∫£m gi√°c m∆∞·ª£t)
      toggleForm();
      if (__confirmShowTimer) clearTimeout(__confirmShowTimer);
      __confirmShowTimer = setTimeout(showConfirmPopup, 1200);

    } catch (err) {
      console.error("‚ùå G·ª≠i l·ªói:", err);
      alert("‚ùå L·ªói g·ª≠i ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i sau.");
    } finally {
      setSendingState(false);
    }
  });
  </script>
</body>
</html>
